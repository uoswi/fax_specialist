---
interface Props {
  end: number;
  suffix?: string;
  label: string;
  icon?: string;
}

const { end, suffix = '', label, icon } = Astro.props;
---

<div class="stat-counter group text-center" data-count={end} data-suffix={suffix}>
  <div class="inline-flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-xl sm:rounded-2xl mb-3 sm:mb-4 mx-auto transition-transform group-hover:scale-110" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(129, 140, 248, 0.1) 100%); border: 1px solid rgba(99, 102, 241, 0.3);">
    <slot name="icon" />
  </div>
  <div class="stat-value text-2xl sm:text-3xl lg:text-4xl xl:text-5xl font-display font-bold mb-1 sm:mb-2" style="background: linear-gradient(135deg, #FFFFFF 0%, #818CF8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
    <span class="stat-number">0</span><span class="stat-suffix">{suffix}</span>
  </div>
  <div class="text-xs sm:text-sm text-gray-400 uppercase tracking-wider">{label}</div>
</div>

<script>
  const stats = document.querySelectorAll('.stat-counter');

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const el = entry.target as HTMLElement;
        const end = parseInt(el.dataset.count || '0');
        const suffix = el.dataset.suffix || '';
        const numberEl = el.querySelector('.stat-number');

        if (numberEl) {
          animateCount(numberEl as HTMLElement, 0, end, 2000);
        }
        observer.unobserve(el);
      }
    });
  }, { threshold: 0.5 });

  stats.forEach(stat => observer.observe(stat));

  function animateCount(el: HTMLElement, start: number, end: number, duration: number) {
    const range = end - start;
    const startTime = performance.now();

    function update(currentTime: number) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3); // Ease out cubic

      const current = Math.floor(start + range * eased);
      el.textContent = current.toLocaleString();

      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }

    requestAnimationFrame(update);
  }
</script>
